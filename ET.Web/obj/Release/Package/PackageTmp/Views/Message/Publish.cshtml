@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutBlog.cshtml";
}
@section Title{
    用户投稿
}
@section Header{
    <link href="/Content/Blog/login.css" rel="stylesheet" />
    <script src="/Scripts/common/jquery.webtopbar.js"></script>
    <script src="~/Scripts/common/jquery-browser.js"></script>
    <script src="/Scripts/Blog/editor.js"></script>
    <link href="/Res/uploadify/uploadify.css" rel="stylesheet" type="text/css" />
    <script src="/Res/uploadify/jquery.uploadify-3.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">
     @if (!Request.IsAuthenticated)
     {
         @:alert('您还未登录！无权操作此页面！'); location.href = '/account/login';
            }
    </script>
}

<div class="content-wrap">
    <div class="content-container">
        <div data-scroll-reveal="" class="row card-panel" data-scroll-reveal-initialized="true" data-scroll-reveal-complete="true">
            <span class="rule-wrap"><a id="tieba" name="tieba" class="rule"></a></span><div class="col span_4_4">
                <div class="ibx-even">
                    <div class="ibx-inner" id="ibx-mod-tieba">
                        <div class="ibx-inner-title">
                            <a target="_blank" href="javascript:;" class="ibx-inner-title-ctx">留言中心</a>
                            <ul class="ibx-inner-title-tab">
                                <li class="ibx-inner-title-tabitem ibx-my-tieba OP_LOG_TITLE current">我要投稿</li>
                                @*<li class="ibx-inner-title-tabitem ibx-my-frs OP_LOG_TITLE">图片收藏</li>
                                    <li class="ibx-inner-title-tabitem ibx-tieba-top OP_LOG_TITLE">我喜欢的</li>*@
                            </ul>
                        </div><div class="ibx-inner-content" id="ibx-tieba">
                            <div class="col my-tieba">
                                <form id="iAddmsgForm" enctype="multipart/form-data">
                                    <center>
                                        <table>
                                            <tr><th>标题：</th><td><input type="text" id="iTitle" name="Title" class="inputstyle" maxlength="50" style="width: 100%" /></td></tr>
                                            <tr><th>类型：</th><td><select name="PublishType" style="width:220px;"><option value="博文引用">博文引用</option><option value="原创文章">原创文章</option><option value="其他">其他</option></select></td></tr>
                                            <tr>
                                                <th>类别：</th>
                                                <td>
                                                    <select name="TypeID" style="width:220px;">
                                                        @foreach (ET.Sys_DEF.KeyAndValue item in @ViewBag.listArticleType)
                                                        {
                                                            <option value="@item.id">@item.text</option>
                                                        }


                                                    </select>
                                                </td>
                                            </tr>
                                            <tr><th>概述：</th><td><textarea id="iDescription" name="Description" class="inputstyle" style="width: 100%;height:100px;" maxlength="200"></textarea></td></tr>
                                            <tr><th>内容：</th><td><textarea id="iPublishContent" name="PublishContent" class="inputstyle" style="width:100%;height:500px;"></textarea></td></tr>
                                            <tr><th>来源：</th><td><input type="text" id="iPublishSource" name="PublishSource" class="inputstyle" maxlength="50" /></td></tr>
                                            <tr>
                                                <th>封面：</th>
                                                <td>
                                                    <input type="file" id="file_upload" class="inputstyle" /><span class="cRed">小图(200*100)为第一张,大图为第二张(830*300)*限10M</span>
                                                    <div class="uploadify-picbox"></div>
                                                </td>
                                            </tr>
                                            <tr><th>标签：</th><td><input type="text" id="iLabel" name="Label" class="inputstyle" maxlength="50" /><span>英文,符号隔开</span></td></tr>
                                            <tr>
                                                <th>验证码：</th>
                                                <td colspan="3">
                                                    <input type="text" id="ivalidatecode" name="validatecode" maxlength="4" class="inputstyle3" />
                                                    <img id="GL_StandardCode" style="cursor: pointer;" src="/account/validatecode?t=@DateTime.Now.Ticks" title="看不清，点击换一张" />
                                                </td>
                                            </tr>
                                            <tr><td></td><td colspan="3"><input id="btnSend" type="button" value="投　稿" style="width:150px;" class="button_blue" /></td></tr>
                                        </table>
                                    </center>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



    </div>
</div>
<style type="text/css">
    .uploadify-itemdel { position: absolute; top: 0; right: 0; background: url("/Images/Public/icon-clear.png") no-repeat white; cursor: pointer; text-indent: -99999px; margin-left: 20px; height: 20px; }
        .uploadify-itemdel:hover { background-color: #ccc; }
    .uploadify-picbox { padding: 5px; border: 1px solid #ccc; height: 100px; overflow: auto; }
        .uploadify-picbox li { float: left; display: block; width: 100px; height: 80px; padding: 2px; border: 1px solid #ccc; margin: 5px; }
    .relative { position: relative; }
</style>
<script type="text/javascript">

    var _publishCover = "";
    $(function () {
        $('#iPublishContent').editor({ tools: 'full' });

        $('#file_upload').uploadify({
            'buttonText': '请选择上传文件',
            'swf': '/Res/uploadify/uploadify.swf',
            'uploader': '/message/upload',
            'sizeLimit ': '10240',
            'fileTypeExts': '*.jpg;*.jpeg;*.bmp;*.gif;*.png;',
            'method': "post",
            'onUploadSuccess': function (file, data, response) {
                var jsondata = JSON.parse(data)
                var html = "<li><div class='relative'> <img src=" + jsondata.SaveName + " width='100px' height='80px' class='uploadify-preimgs'/><span class='uploadify-itemdel'>删除</span></div></li>";
                $(".uploadify-picbox").append(html);
                _publishCover = jsondata.SaveName

            },
            'onFallback': function () {
                alert("您未安装FLASH控件，无法上传图片！请安装FLASH控件后再试。");
            },
            'onError': function (event, queueID, fileObj) {
                alert("文件:" + fileObj.name + " 上传失败");
            }
        });
        $(".uploadify-itemdel").off().on('click', function () {

            $(this).parent().parent().remove();
        });


        $("#GL_StandardCode").click(function () {
            var newSrc = "/message/validatecode?t=" + (new Date()).getTime();
            this.src = newSrc;
            return false;
        });


        $('#btnSend').click(function () {
            if ($('#iTitle').val() == "") {
                $('#iTitle').focus().css({
                    border: "1px solid red",
                    boxShadow: "0 0 2px red"
                });
                TopNotify("标题不能为空", "info");
                return false;
            }
            if ($('#iPublishContent').val() == "") {
                $('#iPublishContent').focus().css({
                    border: "1px solid red",
                    boxShadow: "0 0 2px red"
                });
                TopNotify("内容不能为空", "info");
                return false;
            }


            if ($('#ivalidatecode').val() == "") {
                $('#ivalidatecode').focus().css({
                    border: "1px solid red",
                    boxShadow: "0 0 2px red"
                });
                TopNotify("验证码不能为空", "info");
                return false;
            }


            $('#iTitle').css({
                border: "1px solid #D7D7D7",
                boxShadow: "none"
            });
            $.ajax({
                type: "post",
                url: "/message/ajaxcheckvalidatecode",
                data: "code=" + $("#ivalidatecode").val() + '&t=' + new Date(),
                dataType: 'html',
                async: false,
                success: function (result) {
                    if (result != "true") {
                        $('#ivalidatecode').focus().css({
                            border: "1px solid red",
                            boxShadow: "0 0 2px red"
                        });
                        TopNotify(result, "info");
                        return false;
                        return;
                    } else {
                        $('#ivalidatecode').css({
                            border: "1px solid #D7D7D7",
                            boxShadow: "none"
                        });


                        $(".savepreimgs").remove();
                        var presrc = "";
                        $(".uploadify-preimgs").each(function () {
                            presrc = $(this).attr("src");


                        });
                        presrc = "<input type='hidden' name='Cover'  class='savepreimgs'  value=" + presrc + ">";
                        $("#iAddmsgForm").append(presrc);
                        $.ajax({
                            type: "POST",
                            url: '/message/ajaxaddpublish',
                            data: $('#iAddmsgForm').serialize().replaceAll("'", "''"),
                            async: false,
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                TopNotify(errorThrown, 'error');
                            },
                            success: function (data) {
                                if (data == "true") {
                                    //$("#iAddmsgForm").form("reset");
                                    //TopNotify("信息已提交！请等待管理员审核..！", 'info');
                                    location.href = '/message/pageok'

                                }
                                else
                                    TopNotify(data, 'error');
                            }
                        });
                    }

                }
            });

        });

    })


    function uploadfile() {
        $.ajax({
            type: "POST",
            url: '/message/ajaxaddpublish',
            data: $('#iAddmsgForm').serialize().replaceAll("'", "''"),
            async: false,
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                TopNotify(errorThrown, 'error');
            },
            success: function (data) {
                if (data == "true") {
                    //$("#iAddmsgForm").form("reset");
                    //TopNotify("信息已提交！请等待管理员审核..！", 'info');
                    location.href = '/message/pageok'

                }
                else
                    TopNotify(data, 'error');
            }
        });
    }
</script>
